{"paragraphs":[{"text":"%md\n\n# Advanced SQL Query with SparkSQL\n### with Churn Prediction dataset\n\n* Window function queries : https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf (~p33)\n* Window funcion with PySpark : https://sparkbyexamples.com/spark/spark-sql-window-functions/\n* Window function in time series data : https://blog.jooq.org/2015/05/12/use-this-neat-window-function-trick-to-calculate-time-differences-in-a-time-series/","user":"jhko","dateUpdated":"2020-07-23T15:45:10+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061471_-15848550","id":"20200723-125715_1989044095","dateCreated":"2020-07-23T15:44:21+0000","dateStarted":"2020-07-23T15:45:10+0000","dateFinished":"2020-07-23T15:45:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:65222","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Advanced SQL Query with SparkSQL</h1>\n<h3>with Churn Prediction dataset</h3>\n<ul>\n  <li>Window function queries : <a href=\"https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf\">https://15445.courses.cs.cmu.edu/fall2019/slides/02-advancedsql.pdf</a> (~p33)</li>\n  <li>Window funcion with PySpark : <a href=\"https://sparkbyexamples.com/spark/spark-sql-window-functions/\">https://sparkbyexamples.com/spark/spark-sql-window-functions/</a></li>\n  <li>Window function in time series data : <a href=\"https://blog.jooq.org/2015/05/12/use-this-neat-window-function-trick-to-calculate-time-differences-in-a-time-series/\">https://blog.jooq.org/2015/05/12/use-this-neat-window-function-trick-to-calculate-time-differences-in-a-time-series/</a></li>\n</ul>\n</div>"}]}},{"text":"%pyspark\n\nfrom os.path import abspath\n\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql import Row\nfrom pyspark.ml.feature import VectorAssembler\n\nimport datetime","user":"jhko","dateUpdated":"2020-07-23T15:44:40+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061474_-1906018527","id":"20200723-125523_825659794","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65223"},{"text":"%pyspark\n\nDATAPATH = \"file:///input/project\"\n\nuser_data = spark.read.csv(\"{}/users_train_dist.csv\".format(DATAPATH), header=\"true\") # here we use train data\npost_data = spark.read.csv(\"{}/posts_dist.csv\".format(DATAPATH), header = \"true\")\n\nuser_data.createOrReplaceTempView('Users')\npost_data.createOrReplaceTempView('Posts')\n\nuser_data.printSchema()\npost_data.printSchema()","user":"jhko","dateUpdated":"2020-07-23T15:44:40+0000","config":{"colWidth":12,"fontSize":9,"results":{},"enabled":true,"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061476_-974285000","id":"20200723-125711_1332074409","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65224"},{"text":"%md\n\n## 1. per user, get (average(score), PostTypeId) for each post type\n\nThe following two queries are equivalent!","user":"jhko","dateUpdated":"2020-07-23T15:45:05+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061477_333457809","id":"20200723-130125_1705347985","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65225","dateFinished":"2020-07-23T15:45:05+0000","dateStarted":"2020-07-23T15:45:05+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>1. per user, get (average(score), PostTypeId) for each post type</h2>\n<p>The following two queries are equivalent!</p>\n</div>"}]}},{"text":"%sql\n--- using GROUP BY query\n\n","user":"jhko","dateUpdated":"2020-07-23T15:44:50+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":6,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{},"tableColumnTypeState":{"names":{"OwnerUserId":"string","PostTypeId":"string","avgScore":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false},"multiBarChart":{"rotate":{"degree":"-45"},"xLabelStatus":"default"}},"commonSetting":{},"keys":[{"name":"OwnerUserId","index":0,"aggr":"sum"}],"groups":[],"values":[{"name":"question","index":1,"aggr":"sum"}]},"helium":{}}},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061478_-563523679","id":"20200723-133737_1657800364","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65226"},{"text":"%sql\n--- using AVG()OVER() query\n\n","user":"jhko","dateUpdated":"2020-07-23T15:44:53+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":6,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{},"tableColumnTypeState":{"names":{"OwnerUserId":"string","PostTypeId":"string","AverageScore":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false}},"commonSetting":{}}}},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061479_-1152483286","id":"20200723-134822_327130187","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65227"},{"text":"%md\n\nHowever, `GROUP BY` only displays aggregated values of the group.  \nIt cannot show relevance between tuples within the same group. (e.g. rank, row number, gap between ordered tuples)\n\n","user":"jhko","dateUpdated":"2020-07-23T15:45:03+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061480_-896883021","id":"20200723-141545_1893330817","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65228","dateFinished":"2020-07-23T15:45:03+0000","dateStarted":"2020-07-23T15:45:03+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>However, <code>GROUP BY</code> only displays aggregated values of the group.<br/>It cannot show relevance between tuples within the same group. (e.g. rank, row number, gap between ordered tuples)</p>\n</div>"}]}},{"text":"%md\n## 2. show me rank(average score) of each user","user":"jhko","dateUpdated":"2020-07-23T15:45:05+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061481_-251202541","id":"20200723-142959_2123126698","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65229","dateFinished":"2020-07-23T15:45:05+0000","dateStarted":"2020-07-23T15:45:05+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>2. show me rank(average score) of each user</h2>\n</div>"}]}},{"text":"%sql\n\n--- using RANK()OVER() query\n\n","user":"jhko","dateUpdated":"2020-07-23T15:45:15+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{"columns":[{"name":"OwnerUserId","visible":true,"width":"*","sort":{},"filters":[{}],"pinned":""},{"name":"PostTypeId","visible":true,"width":"*","sort":{},"filters":[{}],"pinned":""},{"name":"postRank","visible":true,"width":"*","sort":{},"filters":[{}],"pinned":""}],"scrollFocus":{},"selection":[],"grouping":{"grouping":[],"aggregations":[],"rowExpandedStates":{}},"treeView":{},"pagination":{"paginationCurrentPage":1,"paginationPageSize":250}},"tableColumnTypeState":{"names":{"Id":"string","avgScore":"string","postRank":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false}},"commonSetting":{}}}},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061483_297432756","id":"20200723-143448_1136336426","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65230"},{"text":"%md\n## 3. Per post, show me gap(its creationdate, previous post's creationdate)","user":"jhko","dateUpdated":"2020-07-23T15:45:16+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061484_-81834304","id":"20200723-150532_7466606","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65231","dateFinished":"2020-07-23T15:45:16+0000","dateStarted":"2020-07-23T15:45:16+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>3. Per post, show me gap(its creationdate, previous post&rsquo;s creationdate)</h2>\n</div>"}]}},{"text":"%sql\n\n--- using LAG()OVER() query\n","user":"jhko","dateUpdated":"2020-07-23T15:45:19+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{},"tableColumnTypeState":{"names":{"OwnerUserId":"string","PostId":"string","CreationDate":"string","PrevCreationDate":"string","Gap":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false}},"commonSetting":{}}}},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061485_2094391435","id":"20200723-144335_1045648711","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65232"},{"text":"%md\n## 3-1. Per user, show me standard deviation of post gap dates. (could be an example feature)\n\n","user":"jhko","dateUpdated":"2020-07-23T15:45:20+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061486_496174852","id":"20200723-153231_620440696","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65233","dateFinished":"2020-07-23T15:45:20+0000","dateStarted":"2020-07-23T15:45:20+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>3-1. Per user, show me standard deviation of post gap dates. (could be an example feature)</h2>\n</div>"}]}},{"text":"%sql\n\n--- using LAG()OVER() query\n\n","user":"jhko","dateUpdated":"2020-07-23T15:45:25+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{},"tableColumnTypeState":{"names":{"OwnerUserId":"string","GapStdev":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false}},"commonSetting":{}}}},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061487_-855438391","id":"20200723-151706_2013096588","dateCreated":"2020-07-23T15:44:21+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65234"},{"text":"%md\nend!\n","user":"jhko","dateUpdated":"2020-07-23T15:45:25+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1595519061488_-767411382","id":"20200723-153541_516299729","dateCreated":"2020-07-23T15:44:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:65235","dateFinished":"2020-07-23T15:45:25+0000","dateStarted":"2020-07-23T15:45:25+0000","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<p>end!</p>\n</div>"}]}}],"name":"AdvancedSQL-dist","id":"2FDYJEJ3W","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"sh:shared_process":[],"spark::2FDYJEJ3W":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}
